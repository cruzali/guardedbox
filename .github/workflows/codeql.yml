name: codeql

on:
  workflow_dispatch:
      inputs:
      languages:
        required: true
        default: 'java, javascript'

jobs:
  codeql:
    runs-on: ubuntu-latest
    steps:

    - name: checkout
      uses: actions/checkout@v2

    - name: cache-node-modules
      uses: actions/cache@v2
      with:
        path: /home/runner/work/guardedbox/guardedbox/node_modules
        key: cache-node-modules-${{ hashFiles('package-lock.json') }}
        restore-keys: cache-node-modules

    - name: cache-mvn-dependencies
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: cache-mvn-dependencies-${{ hashFiles('pom.xml') }}
        restore-keys: cache-mvn-dependencies

    - name: codeql-init
      uses: github/codeql-action/init@v1
      with:
        languages: ${{ github.event.inputs.languages }}
        config-file: ./.github/codeql/codeql-config.yml

    - name: mvn-clean-install
      run: docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /home/runner/work/guardedbox/guardedbox:/guardedbox -v ~/.m2/repository:/root/.m2/repository s3curitybug/guardedbox-build

    - name: codeql-analysis
      uses: github/codeql-action/analyze@v1
